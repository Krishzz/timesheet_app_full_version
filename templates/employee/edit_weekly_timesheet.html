{% extends "base.html" %}
{% block title %}Edit Weekly Timesheet{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Edit Timesheet for Week Starting {{ timesheet.week_start.strftime('%Y-%m-%d') }}</h2>
  <form method="POST" action="{{ url_for('employee.edit_timesheet', ts_id=timesheet.id) }}">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Date</th>
          <th>Clock In</th>
          <th>Clock Out</th>
          <th>Projects (Add multiple rows per day)</th>
        </tr>
      </thead>
      <tbody>
        {% for day_data in entries %}
          {% set i = loop.index0 %}
          <tr>
            <td>{{ day_data.date.strftime('%A, %Y-%m-%d') }}</td>
            <td>
              <input type="time" name="clock_in_{{ i }}" value="{{ day_data.entries[0].clock_in.strftime('%H:%M') if day_data.entries else '' }}" />
            </td>
            <td>
              <input type="time" name="clock_out_{{ i }}" value="{{ day_data.entries[0].clock_out.strftime('%H:%M') if day_data.entries else '' }}" />
            </td>
            <td>
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Project</th>
                    <th>Description</th>
                    <th>Hours</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody class="project-rows" data-day="{{ i }}">
                  {% if day_data.entries %}
                    {% for entry in day_data.entries %}
                      <tr>
                        <td><input type="text" name="project_{{ i }}[]" value="{{ entry.project }}" required /></td>
                        <td><input type="text" name="description_{{ i }}[]" value="{{ entry.description }}" /></td>
                        <td><input type="number" step="0.1" min="0" max="24" name="hours_{{ i }}[]" value="{{ entry.hours }}" required /></td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td><input type="text" name="project_{{ i }}[]" required /></td>
                      <td><input type="text" name="description_{{ i }}[]" /></td>
                      <td><input type="number" step="0.1" min="0" max="24" name="hours_{{ i }}[]" required /></td>
                      <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
              <button type="button" class="btn btn-secondary btn-sm mt-1 add-row" data-day="{{ i }}">Add Project</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="submit" name="action" value="save" class="btn btn-primary">Save as Draft</button>
    <button type="submit" name="action" value="submit" class="btn btn-success ms-2">Submit for Approval</button>
    <a href="{{ url_for('employee.timesheet_view') }}" class="btn btn-secondary ms-2">Cancel</a>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Add project row button handler
  document.querySelectorAll('.add-row').forEach(button => {
    button.addEventListener('click', () => {
      const dayIndex = button.dataset.day;
      const tbody = document.querySelector(`tbody.project-rows[data-day="${dayIndex}"]`);
      const newRow = document.createElement('tr');

      newRow.innerHTML = `
        <td><input type="text" name="project_${dayIndex}[]" required></td>
        <td><input type="text" name="description_${dayIndex}[]"></td>
        <td><input type="number" step="0.1" min="0" max="24" name="hours_${dayIndex}[]" required></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
      `;

      tbody.appendChild(newRow);

      // Attach remove handler to the new button
      newRow.querySelector('.remove-row').addEventListener('click', () => {
        newRow.remove();
      });
    });
  });

  // Remove project row button handler
  document.querySelectorAll('.remove-row').forEach(button => {
    button.addEventListener('click', () => {
      button.closest('tr').remove();
    });
  });
});
</script>
{% endblock %}
